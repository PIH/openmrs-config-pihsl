<!--
  ~ The contents of this file are subject to the OpenMRS Public License
  ~ Version 1.0 (the "License"); you may not use this file except in
  ~ compliance with the License. You may obtain a copy of the License at
  ~ http//license.openmrs.org
  ~
  ~ Software distributed under the License is distributed on an "AS IS"
  ~ basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See the
  ~ License for the specific language governing rights and limitations
  ~ under the License.
  ~
  ~ Copyright (C) OpenMRS, LLC.  All Rights Reserved.
  -->

<htmlform id="pacu-followup" class="simple-form-ui" formUuid="43b275f0-6e20-4538-ba94-19df332d4f76"
          formName="PACU Followup"
          formEncounterType="6f2df970-6e3e-4898-9a34-9d9e8955c3eb" formVersion="1.0">

    <postSubmissionAction class="org.openmrs.module.pihcore.htmlformentry.action.ApplyDispositionAction"/>

    <style type="text/css">
        .simple-form-ui input {
            min-width: 80%
        }

        form fieldset {
            min-width: 90%
        }

        #encounterDate input {
            min-width: 15%
        }

        textarea {
            overflow-y: hidden;
            padding-top: 1.1em;
        }

        @media print {
            .print-form-datestamps { display: block !important }
            button.cancel, button.submit { display: none }
            label { font-weight: bold }
            label[for] { font-weight: normal } /* refers to the radio set label */
        }

        .section-container {
            background: #F2F2F2;
            box-shadow: 3px 3px 3px 1px rgba(0, 0, 0, 0.2);
            padding: 10px 5px 10px 15px;
            line-height: 1.5em; /*add this for vertical spacing between elements*/
        }

        .section-container input[type="checkbox"] {
            margin: 0px 5px; /*changed values to vertical, horizontal*/
            top:5px; /*added to offset the checkbox position to line up*/
        }

        .section-container label { /*new definition to override labels inside section-containers*/
            margin: 0px;
        }

        .section {
            width: 100%;
        }

        .provider-grid {
            display: inline-grid;
            grid-template-columns: 400px 400px;
            background-color: #F2F2F2;
        }

        .provider-grid > div {
            padding-left: 5px;
            border: none;
        }

        .list-inline label, .list-inline input[type="radio"], .list-inline span,
        .list-inline-small label, .list-inline-small input[type="radio"], .list-inline-small span,
        .list-inline-wide label, .list-inline-wide input[type="radio"], .list-inline-wide span,
        .list-inline-extra-wide label, .list-inline-extra-wide input[type="radio"], .list-inline-extra-wide span {
            display: inline-block;
            float: none;
        }

        .list-inline label:first-child {
            width: 220px;
        }

        .list-inline label:first-child {
            width: 170px;
        }

        .list-inline-wide label:first-child {
            width: 320px;
        }

        .list-inline-extra-wide label:first-child {
            width: 420px;
        }

        .four-columns, .three-columns, .two-columns {
            display: table;
            height: 100%;
            width: 100%;
        }

        .two-columns > div {
            display: table-cell;
            width: 50%;
        }

        .score {
            font-size: large;
            font-weight: bold;
        }
        .totalScore {
            font-size: larger;
            font-weight: bolder;
        }

        .small-input input {
            min-width: 7em;
        }
    </style>

    <script type="text/javascript">

        const scoreMap = new Map();
        scoreMap.set('<lookup expression="fn.getConcept('CIEL:170336').id"/>', 2);
        scoreMap.set('<lookup expression="fn.getConcept('CIEL:170337').id"/>', 1);
        scoreMap.set('<lookup expression="fn.getConcept('CIEL:170338').id"/>', 0);
        scoreMap.set('<lookup expression="fn.getConcept('CIEL:170340').id"/>', 2);
        scoreMap.set('<lookup expression="fn.getConcept('CIEL:170341').id"/>', 1);
        scoreMap.set('<lookup expression="fn.getConcept('CIEL:170342').id"/>', 0);
        scoreMap.set('<lookup expression="fn.getConcept('CIEL:170344').id"/>', 2);
        scoreMap.set('<lookup expression="fn.getConcept('CIEL:170345').id"/>', 1);
        scoreMap.set('<lookup expression="fn.getConcept('CIEL:170346').id"/>', 0);
        scoreMap.set('<lookup expression="fn.getConcept('CIEL:160282').id"/>', 2);
        scoreMap.set('<lookup expression="fn.getConcept('CIEL:162645').id"/>', 1);
        scoreMap.set('<lookup expression="fn.getConcept('CIEL:159508').id"/>', 0);
        scoreMap.set('<lookup expression="fn.getConcept('CIEL:170348').id"/>', 2);
        scoreMap.set('<lookup expression="fn.getConcept('CIEL:170349').id"/>', 1);
        scoreMap.set('<lookup expression="fn.getConcept('CIEL:170350').id"/>', 0);


        function calculateAldreteScore(){
            let totalScore = 0;
            jq('.scoreObs').find("input[type='radio']").each(function(index) {
                if (this.checked) {
                    const checkedVal = jq(this).val();
                    const score = scoreMap.get(checkedVal);
                    totalScore = totalScore + score;
                    const parentTd = jq(this).closest('td');
                    if (parentTd) {
                           const scoreColumn = jq(parentTd).next('td');
                           if ( scoreColumn ) {
                                jq(scoreColumn).find('span').text(score);
                            }
                    }
                }

            });
            jq("#totalScore").text(totalScore);
            return totalScore;
        }

        jq(document).ready(function() {

        <ifMode mode="VIEW" include="true" >
            let totalScore = 0;
            <includeIf velocityTest="$fn.getObs($encounter, 'CIEL:170339')">
            const spO2obs = '<lookup complexExpression="$fn.getObs($encounter, 'CIEL:170339').valueCoded.id"/>';
            if (spO2obs) {
                totalScore = totalScore + scoreMap.get(spO2obs);
                jq('#oxygenation_170339').text(scoreMap.get(spO2obs));
                jq('#oxygenation_170339').addClass("value");
            }
            </includeIf>
            <includeIf velocityTest="$fn.getObs($encounter, 'CIEL:170343')">
            const respObs = '<lookup complexExpression="$fn.getObs($encounter, 'CIEL:170343').valueCoded.id"/>';
            if (respObs) {
                totalScore = totalScore + scoreMap.get(respObs);
                jq('#respiration_170343').text(scoreMap.get(respObs));
                jq('#respiration_170343').addClass("value");
            }
            </includeIf>
            <includeIf velocityTest="$fn.getObs($encounter, 'CIEL:170347')">
            const circObs = '<lookup complexExpression="$fn.getObs($encounter, 'CIEL:170347').valueCoded.id"/>';
            if (circObs) {
                totalScore = totalScore + scoreMap.get(circObs);
                jq('#circulation_170347').text(scoreMap.get(circObs));
                jq('#circulation_170347').addClass("value");
            }
            </includeIf>
            <includeIf velocityTest="$fn.getObs($encounter, 'CIEL:162643')">
            const consObs = '<lookup complexExpression="$fn.getObs($encounter, 'CIEL:162643').valueCoded.id"/>';
            if (consObs) {
                totalScore = totalScore + scoreMap.get(consObs);
                jq('#levelOfConsciousness_162643').text(scoreMap.get(consObs));
                jq('#levelOfConsciousness_162643').addClass("value");
            }
            </includeIf>
            <includeIf velocityTest="$fn.getObs($encounter, 'CIEL:170351')">
            const activityObs = '<lookup complexExpression="$fn.getObs($encounter, 'CIEL:170351').valueCoded.id"/>';
            if (activityObs) {
                totalScore = totalScore + scoreMap.get(activityObs);
                jq('#activity_170351').text(scoreMap.get(activityObs));
                jq('#activity_170351').addClass("value");
            }
            </includeIf>
            jq('#totalScore').text(totalScore);
            jq('#totalScore').addClass("value");

        </ifMode>
        <ifMode mode="VIEW" include="false" >
            jq(".scoreObs").find("input[type='radio']").on('click', function(event) {
                calculateAldreteScore();
            });
            calculateAldreteScore();
        </ifMode>
        });
    </script>

    <ifMode mode="VIEW" include="false" >
        <h2>
            <label>
                <uimessage code="Post-anesthesia care unit (PACU) Followup"/>
            </label>
        </h2>
    </ifMode>

    <div class="print-form-datestamps" style="display:none">
        <p><uimessage code="created_on"/>:
            <lookup complexExpression="$form.dateCreated"/>
        </p>
        <p><uimessage code="last_updated_on"/>:
            <lookup complexExpression="$form.dateChanged"/>
        </p>
        <p><uimessage code="printed_on"/>:
            <lookup complexExpression="$formGeneratedDatetime"/>
        </p>
    </div>

    <section id="service-team" sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="Service team">
        <div class="section-container">
            <p class="date-one-line">
                <label>
                    <uimessage code="Encounter date"/>
                </label>
                <encounterDate id="encounterDate" default="now"/>
            </p>

            <p>
                <label>
                    <uimessage code="Location"/>
                </label>
                <encounterLocation default="SessionAttribute:emrContext.sessionLocationId"
                                   tags="PACU Location"/>
            </p>

            <div class="two-columns">
                <div>
                    <!-- Anesthesiologists -->
                    <label>
                        <uimessage code="Overseeing anesthesiologist"/>
                    </label>
                    <encounterProviderAndRole encounterRole="de11b25c-a641-4630-9524-5b85ece9a4f8"
                                              providerRoles="39c28f78-6637-4c21-9bf4-db3e2398054f"
                                              autocompleteProvider="true" required="false" />
                </div>

                <div>
                    <!-- Attending surgeon -->
                    <label>
                        <uimessage code="Overseeing surgeon"/>
                    </label>
                    <encounterProviderAndRole encounterRole="9b135b19-7ebe-4a51-aea2-69a53f9383af"
                                              providerRoles="3182ee51-b895-4804-a342-5f261e995222,556ceee6-d899-43d4-a98b-7973ebc85b75,2fa6f8da-aa58-11e8-98d0-529269fb1459"
                                              autocompleteProvider="true" required="false"/>
                </div>
            </div>
            <br/>

            <p class="date-one-line">
                <label>
                    <uimessage code="Admission date/time"/>
                </label>
                <!-- "Admission date-time (PIH:12240)" -->
                <obs id="admissionDate" conceptId="PIH:12240" showTime="true" default="now"
                     allowFutureDates="false" allowFutureTimes="true"/>
            </p>
        </div>
    </section>

    <section id="dxProc" sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="Diagnoses and procedures">

        <div class="section-container">
            <div>
                <div id="data-collection">
                    <encounterDiagnosesByObs selectedDiagnosesTarget="#encounter-diagnoses-target"/>
                </div>

                <div id="encounter-diagnoses-target">
                </div>
                <br/>

                <div class="two-columns">
                    <div>
                        <h3>
                            <uimessage code="Procedures"/>
                        </h3>
                        <obs conceptId="PIH:Surgical procedure" answerClasses="Procedure" style="autocomplete"/>
                        <obs conceptId="PIH:Surgical procedure" answerClasses="Procedure" style="autocomplete"/>
                        <obs conceptId="PIH:Surgical procedure" answerClasses="Procedure" style="autocomplete"/>
                        <obs conceptId="PIH:Surgical procedure" answerClasses="Procedure" style="autocomplete"/>
                        <obs conceptId="PIH:Surgical procedure" answerClasses="Procedure" style="autocomplete"/>
                    </div>
                    <div>
                        <p class="list-inline">
                            <h3>
                                <uimessage code="Type of anesthesia"/>
                            </h3>
                            <obs conceptId="PIH:Type of anesthesia"
                                 style="radio" answerSeparator=""/>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="vitals" sectionTag="fieldset" headerTag="legend"
             headerStyle="title" headerCode="pihcore.vitalSigns">
        <div class="section-container">
            <subform path="configuration/pih/subforms/vital-signs-basic-widget.xml"/>
        </div>
    </section>

    <section id="aldrete" sectionTag="fieldset" headerTag="legend"
             headerStyle="title" headerCode="Aldrete discharge criteria">
        <div class="section-container">
            <table border="1" cellpadding="5" cellspacing="0" style="width:60%; margin-left: 10px;">
            <thead>
                <tr>
                    <th colspan="2">ALDRETE PACU DISCHARGE CRITERIA</th>
                </tr>
            </thead>
            <tbody>
                <repeat>
                    <template>
                            <tr>
                                <td colspan="2">
                                    <label><strong><uimessage code="pihcore.{category}"/></strong></label>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <obs conceptId="CIEL:{qId}" style="radio" class="scoreObs"
                                     answerConceptIds="{aIds}" answerSeparator="&lt;br /&gt;"/>
                                </td>
                                <td><span id="{category}_{qId}" class="score">0</span>
                                </td>
                            </tr>
                    </template>
                    <render qId="170339" category="oxygenation" aIds="CIEL:170336,CIEL:170337,CIEL:170338"/>
                    <render qId="170343" category="respiration" aIds="CIEL:170340,CIEL:170341,CIEL:170342"/>
                    <render qId="170347" category="circulation" aIds="CIEL:170344,CIEL:170345,CIEL:170346"/>
                    <render qId="162643" category="levelOfConsciousness" aIds="CIEL:160282,CIEL:162645,CIEL:159508"/>
                    <render qId="170351" category="activity" aIds="CIEL:170348,CIEL:170349,CIEL:170350"/>
                </repeat>
                <tr style="border-top: 3px solid black;">
                    <td>
                        <label><strong><uimessage code="Total Score"/></strong></label>
                    </td>
                    <td><span id="totalScore" class="totalScore">0</span></td>
                </tr>
            </tbody>
            </table>
        </div>
    </section>

    <section id="pacu-events" sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="PACU events">
        <div class="section-container two-columns">
            <div>
                <repeat>
                    <template>
                        <p class="list-inline">
                            <label>
                                <uimessage code="{category} score" />
                            </label>
                            <obs conceptId="CIEL:{qId}" style="radio"
                                 answerConceptIds="CIEL:1107,CIEL:1498,CIEL:1499,CIEL:1500" answerSeparator="" />
                        </p>
                    </template>
                    <render qId="169568" category="Pain" />
                    <render qId="170353" category="Nausea" />
                </repeat>

                <repeat>
                    <template>
                        <p class="list-inline">
                            <label>
                                <uimessage code="{qName}"/>
                            </label>
                            <obs conceptId="{qId}" style="radio" answerConceptIds="CIEL:1065,CIEL:1066" />
                        </p>
                    </template>
                    <render qId="CIEL:122983" qName="Vomiting" />
                    <render qId="PIH:21078"   qName="Shivering" />
                    <render qId="CIEL:170354" qName="Ambulation started" />
                    <render qId="CIEL:170355" qName="Feeding started" />
                    <render qId="CIEL:170483" qName="Urinary catheter removed" />
                </repeat>
            </div>
            <div>
                <div>
                    <label>
                        <uimessage code="mirebalais.vitals.gcs" /> (3-15)
                    </label>
                    <p class="small-input">
                        <obs conceptId="CIEL:160347" />
                    </p>
                </div>
            </div>
        </div>
    </section>

    <section id="fluid" sectionTag="fieldset" headerTag="legend" headerStyle="title"
             headerCode="Blood/Fluids">
        <div class="section-container two-columns">
            <div>
                <label>
                    <uimessage code="Blood transfusion"/>
                </label>
                <obsgroup groupingConceptId="PIH:Transfusion construct"
                          hiddenConceptId="PIH:Transfusion of fluid"
                          hiddenAnswerConceptId="PIH:Whole blood">
                    <span class="small">
                        <obs conceptId="CIEL:166650" showUnits="true"/>
                    </span>
                    <br/><br/>

                    <p class="list-inline-small">
                        <label>
                            <uimessage code="Urgency" />
                        </label>
                        <obs conceptId="CIEL:161238" style="radio"
                             answerConceptIds="CIEL:161236,CIEL:1882,PIH:21137"
                             answerCodes="routine,urgent,emergency release" />
                    </p>
                </obsgroup>
            </div>
            <div>
                <label>
                    <uimessage code="Urine output"/>
                </label>
                <span class="small">
                    <obs conceptId="PIH:21114" showUnits="true"/>
                </span>
            </div>
        </div>
    </section>

    <section id="plan" sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="Plan">
        <div class="section-container">
            <p class="side-by-side">
                <div id="disposition">
                    <encounterDisposition />
                </div>
            </p>
        </div>
    </section>
    <br/>

    <ifMode mode="VIEW" include="false">
        <div id="buttons">
            <submit submitClass="confirm right" submitCode="mirebalais.save"/>
            <button type="button" class="cancel">
                <uimessage code="emr.cancel"/>
            </button>
        </div>
    </ifMode>

</htmlform>
