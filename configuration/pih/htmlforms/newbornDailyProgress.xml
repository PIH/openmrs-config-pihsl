<!--
  ~ The contents of this file are subject to the OpenMRS Public License
  ~ Version 1.0 (the "License"); you may not use this file except in
  ~ compliance with the License. You may obtain a copy of the License at
  ~ http//license.openmrs.org
  ~
  ~ Software distributed under the License is distributed on an "AS IS"
  ~ basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See the
  ~ License for the specific language governing rights and limitations
  ~ under the License.
  ~
  ~ Copyright (C) OpenMRS, LLC.  All Rights Reserved.
  -->

<htmlform id="newborn-daily"
          formUuid="6575f0e6-fcae-47ef-9838-4129e60e2cbb"
          htmlformUuid="ac4c6416-5474-4b38-a4f2-2f316f76ee73"
          formName="Newborn Daily Progress"
          formEncounterType="7e42e652-89e7-4559-80fd-41f42826c98c" formVersion="1.0">

    <postSubmissionAction class="org.openmrs.module.pihcore.htmlformentry.action.CleanDiagnosisConstructAction"/>
    <postSubmissionAction class="org.openmrs.module.pihcore.htmlformentry.action.ApplyDispositionAction"/>

    <translations defaultLocale="en">
        <code name="o2Sat">
            <variant locale="en" value="O&lt;sub&gt;2&lt;/sub&gt; Sat"/>
            <variant locale="fr" value="SpO&lt;sub&gt;2&lt;/sub&gt;"/>
            <variant locale="es" value="SatO&lt;sub&gt;2&lt;/sub&gt;"/>
        </code>

        <code name="o2">
            <variant locale="en" value="O&lt;sub&gt;2&lt;/sub&gt;"/>
            <variant locale="fr" value="O&lt;sub&gt;2&lt;/sub&gt;"/>
            <variant locale="es" value="O&lt;sub&gt;2&lt;/sub&gt;"/>
        </code>
        <code name="cm-h2o">
            <variant locale="en" value="cm H&lt;sub&gt;2&lt;/sub&gt;O"/>
            <variant locale="fr" value="cm H&lt;sub&gt;2&lt;/sub&gt;O"/>
            <variant locale="es" value="cm H&lt;sub&gt;2&lt;/sub&gt;O"/>
        </code>
        <code name="transfusion">
            <variant locale="en" value="Blood transfusion"/>
            <variant locale="fr" value="Transfusion sanguine"/>
        </code>
        <code name="type_and_volume">
            <variant locale="en" value="If yes, specify type and volume"/>
            <variant locale="fr" value="Si oui, prÃ©ciser le type et le volume"/>
        </code>
    </translations>

    <style type="text/css">

        form fieldset {
            min-width: 90%
        }

        #encounterDate input {
            min-width: 15%
        }

        textarea {
            overflow-y: hidden; /* fixes scrollbar flash - kudos to @brettjonesdev */
            padding-top: 1.1em; /* fixes text jump on Enter keypress */
        }

        @media print {
            .print-form-datestamps { display: block !important }
            button.cancel, button.submit { display: none }
            label { font-weight: bold }
            label[for] { font-weight: normal } /* refers to the radio set label */
        }

        .section-container {
            background: #F2F2F2;
            box-shadow: 3px 3px 3px 1px rgba(0, 0, 0, 0.2);
            padding: 10px 5px 10px 15px;
            line-height: 1.5em; /*add this for vertical spacing between elements*/
        }

        .section-container input[type="checkbox"] {
            margin: 0px 5px; /*changed values to vertical, horizontal*/
            top:5px; /*added to offset the checkbox position to line up*/
        }

        .section-container label { /*new definition to override labels inside section-containers*/
            margin: 0px;
        }

        - .section {
            width: 100%;
        }

        .side-by-side label {
            display: inline-block;
        }

        .list-inline label, .list-inline input[type="radio"], .list-inline span,
        .list-inline-wide label, .list-inline-wide input[type="radio"], .list-inline-wide span,
        .list-inline-extra-wide label, .list-inline-extra-wide input[type="radio"], .list-inline-extra-wide span {
            display: inline-block;
            float: none;
        }

        .list-inline label:first-child {
            width: 220px;
        }

        .list-inline-wide label:first-child {
            width: 320px;
        }

        .list-inline-extra-wide label:first-child {
            width: 420px;
        }

        form input[type="radio"], .form input[type="radio"] {
            float: none;
            display: inline-block;
        }

        .five-columns, .four-columns, .three-columns, .two-columns {
            display: table;
            height: 100%;
            width: 100%;
        }

        .two-columns > div {
            display: table-cell;
            width: 50%;
        }

        .three-columns > div {
            display: table-cell;
            width: 33%;
        }

        .four-columns > div {
            display: table-cell;
            width: 25%;
        }

        .five-columns > div {
            display: table-cell;
            width: 20%;
        }
        
        .prior-obs-value {
            color: blue;
            font-size: smaller;
        }

        .small-input input {
            min-width: 7em;
        }

        <ifMode mode="VIEW" include="false">
            .date-one-line {
                display: flex;
            }

            .date-one-line label {
                align-self: center;
                margin-right: 1em;
            }

            .date-one-line span {
                display: flex;
            }

            .hasDatepicker {
                min-width: 120px;
                margin-top: 0px;
            }

            .hfe-hours, .hfe-minutes, .hfe-seconds {
                width: 70px;
                min-width: 70px;
                margin: 0px 10px 0px 10px;
            }

            #data-collection {
                display: inline-block;
                width: 58%;
                vertical-align: top;
            }

            #encounter-diagnoses-target {
                display: inline-block;
                width: 40%;
                vertical-align: top;
            }

            #encounter-diagnoses-app {
                margin-bottom: 20px;
            }
        </ifMode>
    </style>
<ifMode mode="ENTER" include="true">
    <script type="text/javascript">
        jq(document).ready(function() {
            let encounterDateValue = jq("#encounterDate .hasDatepicker");
            if (encounterDateValue) {
                const today = new Date();
                let getDate = encounterDateValue.datepicker('getDate');
                if (getDate) {
                    currentEncounterDate = new Date(getDate);
                    if (  (today.getFullYear() !== currentEncounterDate.getFullYear())
                    || (today.getMonth() !== currentEncounterDate.getMonth())
                    || (today.getDate() !== currentEncounterDate.getDate()) ) {
                        // this is retrospective data entry, therefore the encounter datetime needs to be set at midnight by default
                        jq('#encounterDate .hfe-hours').val('0');
                        jq('#encounterDate .hfe-minutes').val('0');
                        currentEncounterDate.setHours(0, 0, 0);
                    }
                }
            }
        });
    </script>
</ifMode>
<ifMode mode="VIEW" include="false">
    <script type="text/javascript">
        jq(document).ready(function() {

            jq('.normalObs').change(function(event) {
                // get the Obs checkbox value
                var firstCheckbox = jq(this).children(":checkbox:first").prop('checked');
                if (firstCheckbox == true) {
                    var parentDiv = jq(this).closest('.exam');
                    if (parentDiv != null) {
                        jq(parentDiv).find('.abnormalObs').each(function(index, element) {
                            jq(this).children(":checkbox:first").prop('checked', false);
                        });
                    }
                }
            });

            jq('.abnormalObs').change(function(event) {
                var firstCheckbox = jq(this).children(":checkbox:first").prop('checked');
                if (firstCheckbox == true) {
                    var parentDiv = jq(this).closest('.exam');
                    if (parentDiv != null) {
                        jq(parentDiv).find('.normalObs').each(function(index, element) {
                            jq(this).children(":checkbox:first").prop('checked', false);
                        });
                    }
                }
            });

            // handlers for next and submit buttons, see nextAndSubmitButtons.js
            setUpNextAndSubmitButtons();

            const contextPath = window.location.href.split('/')[3];
            const apiBaseUrl =  "/" + contextPath + "/ws/rest/v1";
            const patientUuid = '<lookup expression="patient.uuid"/>';
            const birthWeightConceptUuid='<lookup expression="fn.getConcept('CIEL:5916').uuid"/>';
            const weightConceptUuid='<lookup expression="fn.getConcept('CIEL:5089').uuid"/>';
            const birthLengthConceptUuid='<lookup expression="fn.getConcept('CIEL:163554').uuid"/>';
            let lastBirthWeight = 0;
            let lastBirthWeightDatetime = 0;
            let lastWeight = 0;
            let lastWeightDatetime = '';
            let lastBirthLength = 0;
            let lastBirthLengthDatetime = 0;


            jq("#weight_kg").find("input[type='text']").change( function(event) {
                jq("#weight_kg").find(".field-error").html(' ').hide();
                let weight = jq(this).val();
                if ( lastBirthWeight &amp;&amp; weight) {
                    let errorMessage = '';
                    if (Number.isNaN(weight)) {
                        //invalid number
                        errorMessage = "Not a valid number";
                    } else {
                        //valid number
                        let weightPercent = (weight / lastBirthWeight) * 100;
                        if ( weightPercent &lt;= 90) {
                            errorMessage = "Weight is 10% less than birth weight";
                        }
                    }
                    if ( errorMessage ) {
                        setTimeout( () => {
                            jq("#weight_kg").find(".field-error").html(errorMessage).show();
                        } , 100);
                    }
                }
            });

            let currentEncounterDate = '';
            let encounterDate = '<lookup expression="encounter.getEncounterDatetime().getTime()"/>';
            const currentEncUuid = '<lookup expression="encounter.uuid"/>';
            if (typeof encounterDate !== "undefined" &amp;&amp; encounterDate !== null &amp;&amp; (encounterDate.length > 0)) {
                currentEncounterDate = new Date(+encounterDate);
            } else {
                // look for the encounterDate datepicker widget
                let encounterDateValue = jq("#encounterDate .hasDatepicker");
                if (encounterDateValue) {
                    let getDate = encounterDateValue.datepicker('getDate');
                    if (getDate) {
                        currentEncounterDate = new Date(getDate);
                    }
                }
            }
            if ( currentEncounterDate ) {
                    const today = new Date();
                    if ( (currentEncounterDate.getHours() === 0 ) &amp;&amp;  (currentEncounterDate.getMinutes() === 0)
                            &amp;&amp;  (today.getFullYear() == currentEncounterDate.getFullYear())
                            &amp;&amp; (today.getMonth() == currentEncounterDate.getMonth())
                            &amp;&amp; (today.getDate() == currentEncounterDate.getDate()) ) {
                        // encounter is from today, therefore we need to add the time component, the current time of the day
                        currentEncounterDate = today;
                    }
                    let nextDayFromEncDate = new Date(currentEncounterDate);
                    nextDayFromEncDate.setDate(nextDayFromEncDate.getDate() + 2); //to overcome the annoying problem when the client and the server are in different time zones
                    let restEncMonth = nextDayFromEncDate.getMonth() + 1;
                    let restEncDay = nextDayFromEncDate.getDate(); // to catch all encounters from today
                    let restEncDate = nextDayFromEncDate.getFullYear() + '-' + restEncMonth + '-' + restEncDay;

                    // looking for a previous weight obs within the same visit
                    jq.getJSON(apiBaseUrl + "/encounter", {
                        patient: patientUuid,                        
                        todate: restEncDate,
                        order: 'desc',
                        v: 'custom:(id,uuid,patient:(uuid),encounterType:(uuid),visit:(uuid,startDatetime,stopDatetime),encounterDatetime,voided,obs:(uuid,display,concept:(uuid,display),obsDatetime,valueCoded:(uuid,display),valueDatetime,valueNumeric,valueText,groupMembers:(uuid,display,person:(uuid),concept:(uuid,display),obsDatetime,valueCoded:(uuid,display),valueDatetime,valueNumeric,valueText,voided),voided)'
                      }, function( data ) {
                        if (data.results.length &gt; 0) {
                            for (let index = 0; index &lt; data.results.length; index++) {
                                let newbornEnc = data.results[index];
                                let encDatetime = new Date(newbornEnc.encounterDatetime);
                                if ( newbornEnc.visit &amp;&amp; newbornEnc.visit.startDatetime ) {
                                    let visitStartDatetime = new Date(newbornEnc.visit.startDatetime);
                                    if ( (visitStartDatetime.getTime()  &lt;=  currentEncounterDate.getTime())
                                        &amp;&amp; (!newbornEnc.visit.stopDatetime || (new Date(newbornEnc.visit.stopDatetime)).getTime() &gt;=  currentEncounterDate.getTime())
                                        ) {
                                        //our form's encounter date falls within this visit
                                        if (newbornEnc.obs &amp;&amp; newbornEnc.obs.length &gt; 0) {
                                            for (let j=0; j &lt; newbornEnc.obs.length; j++) {
                                                let obs = newbornEnc.obs[j];
                                                if (obs.concept.uuid === birthWeightConceptUuid &amp;&amp; !lastBirthWeight) {
                                                    lastBirthWeight = obs.valueNumeric;
                                                    lastBirthWeightDatetime = new Date(obs.obsDatetime);
                                                    jq("#birthWeightBox").show();
                                                    jq("#birthWeightInfo").html(lastBirthWeight + "kg <br></br>(" + lastBirthWeightDatetime.toLocaleDateString() + " " + lastBirthWeightDatetime.toLocaleTimeString() + ")");
                                                } else if (obs.concept.uuid === birthLengthConceptUuid &amp;&amp; !lastBirthLength) {
                                                    lastBirthLength = obs.valueNumeric;
                                                    lastBirthLengthDatetime = new Date(obs.obsDatetime);
                                                    jq("#birthLengthBox").show();
                                                    jq("#birthLengthInfo").html(lastBirthLength + "cm <br></br>(" + lastBirthLengthDatetime.toLocaleDateString() + " " + lastBirthLengthDatetime.toLocaleTimeString() + ")");
                                                } else if (obs.concept.uuid === weightConceptUuid
                                                    &amp;&amp; (encDatetime.getTime() &lt;= currentEncounterDate.getTime())
                                                    &amp;&amp; (!currentEncUuid || (currentEncUuid !==newbornEnc.uuid))
                                                    &amp;&amp; !lastWeight ) {
                                                    lastWeight = obs.valueNumeric;
                                                    lastWeightDatetime = new Date(obs.obsDatetime);
                                                    jq("#lastWeightKg").html(lastWeight + "kg <br></br>(" + lastWeightDatetime.toLocaleDateString() + " " + lastWeightDatetime.toLocaleTimeString() + ")");
                                                }
                                            }
                                        }
                                        if (lastBirthWeight &amp;&amp; lastWeight &amp;&amp; lastBirthLength ) {
                                            // no need to continue iterating over the list of encounters.
                                            // we already found the latest weight and length obs values
                                            break;
                                        }
                                    }
                                }
                            }
                        }
                      });
                }
        });
    </script>
</ifMode>

    <div class="print-form-datestamps" style="display:none">
        <p><uimessage code="pihcore.form.created_on"/>:
            <lookup complexExpression="$form.dateCreated"/>
        </p>
        <p><uimessage code="pihcore.form.last_updated_on"/>:
            <lookup complexExpression="$form.dateChanged"/>
        </p>
        <p><uimessage code="pihcore.form.printed_on"/>:
            <lookup complexExpression="$formGeneratedDatetime"/>
        </p>
    </div>

    <ifMode mode="VIEW" include="false">
        <h2>
            <label>
                <uimessage code="pih.task.newbornDailyProgress"/>
            </label>
        </h2>
    </ifMode>

    <subform path="configuration/pih/subforms/encounter-provider-location-date.xml">
        <span subform-parameter="encounter-location-widget">
            <encounterLocation default="SessionAttribute:emrContext.sessionLocationId" tags="Newborn Daily Progress Location"/>
        </span>
        <span subform-parameter="encounter-provider-widget">
            <encounterProviderAndRole default="currentUser"
                                      encounterRole="4f10ad1a-ec49-48df-98c7-1391c6ac7f05"
                                      providerRoles="${providerGroup.group1}"
                                      required="true"/>
        </span>
    </subform>

    <enrollInProgram programId="Infant" locationTag="Program Location " />

    <ifMode mode="VIEW" include="false">
        <section id="Overview" sectionTag="fieldset" headerTag="legend" headerStyle="title"
                 headerCode="Newborn overview">
            <div class="section-container">
                <p id="when" class="date-one-line">
                    <label>
                        <uimessage code="Date &amp; time of delivery"/>
                    </label>
                    <lookup complexExpression="#set( $deliveryDate = $fn.latestObsBeforeCurrentEncounter('CIEL:5599', true) )"/>
                    <includeIf velocityTest="($deliveryDate) ">
                        <lookup complexExpression="$deliveryDate.valueDatetime"  format="dd MMM yyyy h:mm aa"/>
                    </includeIf>
                </p>

                <lookup complexExpression="#set( $deliveryType = $fn.latestObsBeforeCurrentEncounter('PIH:11663', true) )"/>
                <includeIf velocityTest="($deliveryType) ">
                    <p class="side-by-side">
                        <label>
                            <uimessage code="Type of delivery"/>:
                        </label>
                        <lookup complexExpression="$deliveryType.valueCoded.name"/>
                    </p>
                </includeIf>

                <div id="alive-details">
                        <!-- APGAR -->
                        <div class="three-columns">
                            <div class="apgar">
                                <label>
                                    <uimessage code="pihcore.mch.apgarScore1"/>
                                </label>
                                <!-- APGAR at 1 minutes -->
                                <lookup complexExpression="#set( $apgarOne = $fn.latestObsBeforeCurrentEncounter('PIH:14419', true) )"/>
                                <includeIf velocityTest="($apgarOne) ">
                                    <lookup complexExpression="$apgarOne.valueNumeric"/>
                                    (<lookup complexExpression="$apgarOne.obsDatetime"/>)
                                </includeIf>
                            </div>
                            <div class="apgar">
                                <label>
                                    <uimessage code="pihcore.mch.apgarScore"/>
                                </label>
                                <!-- APGAR at 5 minutes <obs conceptId="CIEL:159604"/> -->
                                <lookup complexExpression="#set( $apgarFive = $fn.latestObsBeforeCurrentEncounter('CIEL:159604', true) )"/>
                                <includeIf velocityTest="($apgarFive) ">
                                    <lookup complexExpression="$apgarFive.valueNumeric"/>
                                    (<lookup complexExpression="$apgarFive.obsDatetime"/>)
                                </includeIf>
                            </div>

                            <div class="apgar">
                                <label>
                                    <uimessage code="pihcore.mch.apgarScore10"/>
                                </label>
                                <!-- APGAR at 10 minutes <obs conceptId="PIH:14785"/> -->
                                <lookup complexExpression="#set( $apgarTen = $fn.latestObsBeforeCurrentEncounter('PIH:14785', true) )"/>
                                <includeIf velocityTest="($apgarTen) ">
                                    <lookup complexExpression="$apgarTen.valueNumeric"/>
                                    (<lookup complexExpression="$apgarTen.obsDatetime"/>)
                                </includeIf>
                            </div>
                        </div>
                        <br/>
                </div>

                <!-- Resuscitated -->
                <lookup complexExpression="#set( $neoResusc = $fn.latestObsBeforeCurrentEncounter('CIEL:162131', true) )"/>
                <includeIf velocityTest="($neoResusc) ">
                    <p class="side-by-side">
                        <label>
                            <uimessage code="pihcore.neoResusc"/>:
                        </label>
                        <lookup complexExpression="$neoResusc.valueCoded.name"/>
                        (<lookup complexExpression="$neoResusc.obsDatetime"/>)
                    </p>
                </includeIf>
            </div>
        </section>
    </ifMode>

    <section id="vitals" sectionTag="fieldset" headerTag="legend"
             headerStyle="title" headerCode="pihcore.vitalSigns">
        <div class="section-container">
            <subform path="configuration/pih/subforms/vital-signs-infant-widget.xml"/>
        </div>
    </section>

    <section id="newbornCondition" sectionTag="fieldset" headerTag="legend"
             headerStyle="title" headerCode="pihcore.newborn.condition">
        <div class="section-container">
            <table>
                <tr>
                    <td>
                        <div class="four-columns">
                            <div>
                                <p class="side-by-side">
                                    <label>
                                        <uimessage code="Weight"/>
                                    </label>
                                    <ifMode mode="VIEW" include="false">
                                            <span id="lastWeightKg" class="prior-obs-value"> </span>
                                        <br/>
                                    </ifMode>
                                    <obs conceptId="CIEL:5089" id="weight_kg" showUnits="emr.units.kilograms"
                                         unitsCssClass="append-to-value"/>
                                </p>

                                <p id="birthWeightBox" class="side-by-side hidden" >
                                    <span class="prior-obs-value">
                                        <label>
                                            <uimessage code="Birth Weight:"/>
                                        </label>
                                        <span id="birthWeightInfo"></span>
                                    </span>
                                </p>
                            </div>

                            <div>
                                <p>
                                    <label>
                                        <uimessage code="Length"/>
                                    </label>
                                    <obs conceptId="CIEL:5090" showUnits="true"/>
                                </p>
                                <p id="birthLengthBox" class="side-by-side hidden" >
                                    <span class="prior-obs-value">
                                        <label>
                                            <uimessage code="Birth Length:"/>
                                        </label>
                                        <span id="birthLengthInfo"></span>
                                    </span>
                                </p>
                            </div>

                            <div>
                                <label>
                                    <uimessage code="Head circumference"/>
                                </label>
                                <obs conceptId="CIEL:5314" showUnits="true"/>
                            </div>

                            <div>
                                <label>
                                    <uimessage code="mirebalais.vitals.muac.navigation.title"/>
                                </label>
                                <obs conceptId="CIEL:1343" id="muac_c"
                                     showUnits="true" unitsCssClass="append-to-value"/>
                            </div>
                        </div>
                    </td>
                </tr>
            </table>
        </div>
    </section>

    <section id="labs" sectionTag="fieldset" headerTag="legend" headerStyle="title"
             headerCode="Lab results">
        <div class="section-container" >
            <div style="width: 30%">
                <!-- Serum glucose (CIEL:887) Test/Numeric with units-->
                <label>
                    <uimessage code="Blood glucose (RBG)" />
                </label>
                <span class="small">
                    <obs conceptId="CIEL:887" id="glucose"
                         showUnits="true" unitCssClass="append-to-value" />
                </span>
            </div>
        </div>
    </section>

    <section id="exam" sectionTag="fieldset" headerTag="legend" headerStyle="title"
             headerCode="Physical exam">
        <div class="section-container">
            <p>
                <h4>
                    <uimessage code="Umbilical cord stump"/>
                </h4>
                <div class="two-columns exam">
                    <div>
                        <repeat>
                            <template>
                                <obs class="{normAb}" style="checkbox"
                                     conceptId="CIEL:162121"
                                     answerConceptId="{answer}" answerCode="{comment}"/>
                            </template>
                            <render normAb="normalObs" answer="CIEL:162122" comment="Clean" />
                            <render normAb="normalObs" answer="CIEL:162120" comment="Dry" />
                            <render normAb="abnormalObs" answer="CIEL:162124" comment="Moist" />
                            <render normAb="abnormalObs" answer="PIH:1670" comment="Sticky"/>
                        </repeat>
                    </div>
                    <div>
                        <label>Comments about umbilical cord</label>
                        <obs conceptId="CIEL:168722" style="text" />
                    </div>
                </div>
            </p>

            <p>
                <h4>
                    <uimessage code="Eyes"/>
                </h4>
                <div class="two-columns exam">
                    <div>
                        <repeat>
                            <template>
                                <obs class="{normAb}" style="checkbox"
                                     conceptId="CIEL:163309"
                                     answerConceptId="{answer}" answerCode="{comment}" />
                            </template>
                            <render normAb="normalObs"   answer="PIH:3236"    comment="Clear" />
                            <render normAb="abnormalObs" answer="CIEL:127777" comment="Red eyes" />
                            <render normAb="abnormalObs" answer="CIEL:160910" comment="Yellow eyes" />
                            <render normAb="abnormalObs" answer="CIEL:168745" comment="Sticky eyes"/>
                            <render normAb="abnormalObs" answer="CIEL:168747" comment="Sticky right eye"/>
                            <render normAb="abnormalObs" answer="CIEL:168746" comment="Sticky left eye"/>
                        </repeat>
                    </div>
                    <div>
                        <label>Comments about eyes</label>
                        <obs conceptId="CIEL:168722" style="text" />
                    </div>
                </div>
            </p>

            <p>
                <h4>
                    <uimessage code="Skin color"/>
                </h4>
                <div class="two-columns exam">
                    <div>
                        <repeat>
                            <template>
                                <obs class="{normAb}" style="checkbox"
                                     conceptId="CIEL:1120"
                                     answerConceptId="{answer}" answerCode="{comment}"/>
                            </template>
                            <render normAb="normalObs" answer="CIEL:1115" comment="Normal (pink)" />
                            <render normAb="abnormalObs" answer="CIEL:143050" comment="Cyonosis (blue)" />
                            <render normAb="abnormalObs" answer="CIEL:115368" comment="Jaundice"/>
                        </repeat>
                    </div>
                    <div>
                        <label>Comments about skin</label>
                        <obs conceptId="CIEL:160981" style="text" />
                    </div>
                </div>
            </p>

            <p>
                <h4>
                    <uimessage code="Urination"/>
                </h4>
                <div class="two-columns">
                    <div>
                        <p class="side-by-side">
                            <obs conceptId="CIEL:166358" style="radio"
                                 answerConceptIds="CIEL:1115,CIEL:148566"
                                 answerSeparator="&lt;br /&gt;"
                                 answerCodes="Normal (passed urine),Anuria (No urination)"/>
                        </p>
                    </div>
                    <div>
                        <label>Comments about urination</label>
                        <obs conceptId="CIEL:166363" style="text" />
                    </div>
                </div>
            </p>

            <p class="side-by-side">
                <h4>
                    <uimessage code="Stool"/>
                </h4>
                <div class="two-columns">
                    <div>
                        <p class="side-by-side">
                            <!-- ToDo:  Add meconium labels? -->
                            <obs conceptId="CIEL:163640" style="radio"
                                 answerConceptIds="CIEL:168748,CIEL:168749,CIEL:160910,CIEL:1107"
                                 answerSeparator="&lt;br /&gt;" />
                            <!-- answerCodes="Meconium,Brown/Green,Yellow,None"/ -->
                        </p>
                    </div>
                    <div>
                        <label>Comments about stool</label>
                        <obs conceptId="CIEL:160965" style="text" />
                    </div>
                </div>
            </p>

            <p class="side-by-side">
                <h4>
                    <uimessage code="pihcore.exam.neuro_exam"/>
                </h4>
                <div class="two-columns">
                    <div>
                        <p class="side-by-side">
                            <obs conceptId="CIEL:1129" style="radio"
                                 answerConceptIds="CIEL:1115,CIEL:1116"/>
                        </p>

                        <p class="side-by-side">
                            <label>
                                <uimessage code="Seizures" />
                            </label>
                            <obs conceptId="PIH:206" style="radio"
                                 answerConceptIds="CIEL:1065,CIEL:1066"
                                 answerCodes="yes,no"/>
                        </p>
                    </div>
                    <div>
                        <label>Comments about neurological exam</label>
                        <obs conceptId="PIH:11570" style="text" />
                    </div>
                </div>
            </p>

            <p class="side-by-side">
                <h4>
                    <uimessage code="pihcore.exam.cardiac_exam"/>
                </h4>
                <div class="two-columns">
                    <div>
                        <p class="side-by-side">
                            <obs conceptId="CIEL:1124" style="radio"
                                 answerConceptIds="CIEL:1115,CIEL:562"/>
                        </p>
                    </div>
                    <div>
                        <label>Comments about cardiac exam</label>
                        <obs conceptId="CIEL:163046" style="text" />
                    </div>
                </div>
            </p>
        </div>
    </section>

    <section id="dx" sectionTag="fieldset" headerTag="legend" headerStyle="title"
             headerCode="Diagnoses">
        <div class="section-container">

            <div id="data-collection">
                <encounterDiagnosesByObs selectedDiagnosesTarget="#encounter-diagnoses-target"/>
            </div>

            <div id="encounter-diagnoses-target">
            </div>

            <p>
                <!-- Free-text comment -->
                <label>
                    <uimessage code="pih.app.notes.summary"/>
                </label>
                <obs conceptId="CIEL:161011" style="textarea"/>
            </p>

        </div>
    </section>

    <section id="inputs" sectionTag="fieldset" headerTag="legend" headerStyle="title"
             headerCode="Inputs">
        <div class="section-container">
            <h6>
                <uimessage code="Feeding method"/>
            </h6>

            <repeat>
                <template>
                    <obs conceptId="CIEL:1151" style="checkbox"
                         answerConceptId="CIEL:{answer}"
                         answerCode="{aLabel}"/>
                </template>
                <render answer="5632"   aLabel="breastfed" />
                <render answer="5254"   aLabel="formula" />
                <render answer="170412" aLabel="nil per oral (NPO)" />
            </repeat>
            <br/>

            <p class="side-by-side">
                <obs conceptId="CIEL:168734" style="radio"
                     answerConceptIds="CIEL:168743,CIEL:168735,CIEL:168742"
                     answerCodes="Tube,Cup,Spoon"/>
            </p>

            <div>
                <p>
                    <h6>
                        <uimessage code="IV"/>
                    </h6>

                    <obs conceptId="CIEL:165995" toggle="ivf"
                         answerConceptId="CIEL:1765" answerCode="Intravenous (IV) access"
                         style="checkbox"/>
                </p>

                <div id="ivf">
                    <table style="border: 0px; width: 90%;">
                        <tr style="border: 0px;  background-color: #F2F2F2;">
                            <td style="border: 0px;  background-color: #F2F2F2;">
                                <p>
                                    <label>
                                        <uimessage code="Date of IV placement" />
                                    </label>
                                    <obs conceptId="PIH:20289" allowTime="false" />
                                </p>

                                <p class="side-by-side">
                                    <label>
                                        <uimessage code="Site of IV" />
                                    </label>
                                    <br/>
                                    <obs conceptId="CIEL:166006" style="radio"
                                         answerConceptIds="CIEL:166309,CIEL:164385,CIEL:166241,CIEL:164387,PIH:21117"/>
                                </p>
                            </td>
                            <td style="border: 0px;  background-color: #F2F2F2; vertical-align: top">
                                <p class="side-by-side">
                                    <label>
                                        <uimessage code="Number of days with IV" />
                                    </label>
                                    <obs conceptId="PIH:20290" size="3"  />
                                </p>
                            </td>
                        </tr>
                        <tr style="border: 0px;  background-color: #F2F2F2;">
                            <obsgroup groupingConceptId="PIH:IVF construct">
                                <td style="border: 0px;  background-color: #F2F2F2;">

                                    <label>
                                        <uimessage code="pihcore.ivf"/> (IVF)
                                    </label>
                                    <p>
                                        <repeat>
                                            <template>
                                                <obs conceptId="PIH:IVF administered" style="checkbox"
                                                     answerConceptId="{answer}"
                                                     answerCode="{aLabel}" />
                                            </template>
                                            <render answer="CIEL:74653" aLabel="Dextran" />
                                            <render answer="CIEL:80804" aLabel="Normal saline (NS) 0.9%" />
                                            <render answer="PIH:7898"   aLabel="Dextrose (D) 5% in sodium chloride 0.45%" />
                                            <render answer="CIEL:161250" aLabel="Dextrose (D) 5% in water" />
                                            <render answer="CIEL:161922" aLabel="Dextrose (D) 10% in water" />
                                            <render answer="CIEL:161924" aLabel="Mannitol 20%" />
                                            <render answer="CIEL:78617" aLabel="Ringer's lactate (RL)" />
                                            <render answer="PIH:20465" aLabel="1 part RL to 4 parts D10%" />
                                            <render answer="PIH:20466" aLabel="75mL D5% + 5mL D50% + 20mL NS + 1mL calcium gluconate" />
                                            <render answer="PIH:21128" aLabel="75mL D5% + 5mLD50% + 20mL NS + 1mL calcium gluconate + magnesium sulfate" />
                                            <render answer="PIH:21129" aLabel="Dextrose 5% + magnesium sulfate" />
                                            <render answer="PIH:21130" aLabel="Dextrose 10% + magnesium sulfate" />
                                        </repeat>

                                    </p>
                                </td>
                                <td style="border: 0px;">
                                    <label>
                                        <uimessage code="pihcore.ivfVol" />
                                    </label>
                                    <p class="small-input">
                                        <obs conceptId="CIEL:170482" showUnits="true"/>
                                    </p>
                                </td>
                            </obsgroup>
                        </tr>
                    </table>
                </div>
            </div>

            <h6>
                <uimessage code="Respiration" />
            </h6>
            <div class="two-columns">
                <div>
                    <p class="side-by-side">
                        <label>
                            <uimessage code="Air supply" />
                        </label>
                        <br/>
                        <obs id="air" conceptId="CIEL:162739" style="radio"
                             answerConceptIds="CIEL:162735,CIEL:162738,CIEL:165944"
                             answerSeparator="&lt;br /&gt;">
                            <controls>
                                <when value="CIEL:165944" thenDisplay="#cpap"/>
                                <when value="CIEL:162738" thenDisplay="#oxy2"/>
                            </controls>
                        </obs>
                    </p>
                </div>
                <div>
                    <div id="oxy2">
                        <label>
                            <uimessage code="o2"/> flow rate
                        </label>
                        <span class="small">
                            <obs conceptId="CIEL:165986" showUnits="true"/>
                        </span>
                    </div>
                    <div id="cpap">
                        <label>
                            <uimessage code="CPAP machine pressure"/>
                        </label>
                        <span class="small">
                            <obs conceptId="PIH:20357" showUnits="cm-h2o"/>
                        </span>

                        <label>
                            <uimessage code="FiO2"/>
                        </label>
                        <span class="small">
                            <obs conceptId="CIEL:165927" showUnits="true"/>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Apnea -->
            <div class="two-columns">
                <div>
                    <obsgroup groupingConceptId="PIH:Visit Diagnoses" showIfEmpty="false">
                        <obs id="apnea-q" conceptId="PIH:DIAGNOSIS" style="checkbox"
                             answerConceptId="CIEL:121519" >
                            <controls>
                                <when value="CIEL:121519" thenDisplay="#apnea-duration" />
                            </controls>
                        </obs>
                    </obsgroup>
                    <br/>
                </div>

                <div id="apnea-duration">
                    <label>
                        <uimessage code="if apnea, specify apnea duration:" />
                    </label>
                    <obs conceptId="PIH:20460" showUnits="true"/>
                </div>
            </div>

            <div>
                <p class="list-inline">
                    <label>
                        <uimessage code="pihcore.neoResusc"/>
                    </label>
                    <obs id="resuscitation" conceptId="CIEL:162131"
                         answerConceptIds="CIEL:1065,CIEL:1066"
                         answerCodes="yes,no"
                         style="radio" >
                        <controls>
                            <when value="CIEL:1065" thenDisplay="#type-resuscitation"/>
                        </controls>
                    </obs>
                </p>

                <div id="type-resuscitation">
                    <table style="border: 0px; width: 90%;">
                        <tr>
                            <td style="border: 0px;  background-color: #F2F2F2;">
                                <label>
                                    <uimessage code="Method of resuscitation"/>
                                </label>
                                <p>
                                    <repeat>
                                        <template>
                                            <obs conceptId="CIEL:165995" style="checkbox"
                                                 answerConceptId="{management}"/>
                                        </template>
                                        <render management="CIEL:162738" aLabel="Supplemental oxygen"/>
                                        <render management="CIEL:167383" aLabel="Ventilation bag"/>
                                        <render management="CIEL:165935" aLabel="Endotrachial intubation"/>
                                        <render management="CIEL:167415" aLabel="Heart massage"/>
                                    </repeat>

                                </p>

                                <p class="side-by-side">
                                    <label>
                                        <uimessage code="Number of days with respiratory support"/>
                                    </label>
                                    <obs conceptId="PIH:20291"/>
                                </p>
                            </td>
                        </tr>
                    </table>
                </div>

                <h6>
                    <uimessage code="Blood"/>
                </h6>
                <div class="two-columns">
                    <div>
                        <p class="list-inline">
                            <label>
                                <uimessage code="transfusion"/>
                            </label>
                            <obs id="transfusion-q" conceptId="PIH:Transfusion status" style="radio"
                                 answerConceptIds="PIH:YES,PIH:NO" answerCodes="yes,no">
                                <controls>
                                    <when value="CIEL:1065" thenDisplay="#transfusion-details" />
                                </controls>
                            </obs>
                        </p>
                    </div>
                    <div></div>
                </div>


                <div id="transfusion-details" >
                    <p class="list-inline">
                        <label>
                            <uimessage code="Type of transfusion"/>
                        </label>
                        <obs conceptId="PIH:20464" style="radio"
                             answerConceptIds="PIH:20463,CIEL:167423"
                             answerCodes="simple,exchange"/>
                    </p>

                    <div class="four-columns">
                        <repeat>
                            <template>
                                <div>
                                    <obsgroup groupingConceptId="PIH:Transfusion construct">
                                        <obs conceptId="PIH:Transfusion of fluid" answerConceptId="PIH:{answer}"/>
                                        <span class="small">
                                            <obs conceptId="CIEL:166650" showUnits="true"/>
                                        </span>
                                    </obsgroup>
                                </div>
                            </template>
                            <render answer="Whole blood" />
                            <render answer="Packed red blood cells" />
                            <render answer="Plasma" />
                            <render answer="Platelets" />
                        </repeat>
                    </div>

                    <obsgroup groupingConceptId="PIH:Visit Diagnoses" showIfEmpty="false">
                        <obs id="blood-reaction" conceptId="PIH:DIAGNOSIS" style="checkbox"
                             answerConceptId="CIEL:147119" />
                    </obsgroup>
                    <br/>
                </div>

            </div>
        </div>
    </section>

    <section id="outputs" sectionTag="fieldset" headerTag="legend" headerStyle="title"
             headerCode="Outputs">
        <div class="section-container two-columns">
            <div>
                <label>
                    <uimessage code="Urine output"/>
                </label>
                <p class="small-input">
                    <obs conceptId="PIH:21114" showUnits="true"/>
                </p>
            </div>
            <div>
                <label>
                    <uimessage code="Estimated blood loss"/>
                </label>
                <p class="small-input">
                    <obs conceptId="PIH:12555" showUnits="true"/>
                </p>
            </div>
        </div>
    </section>

    <section id="treatment-support" sectionTag="fieldset" headerTag="legend" headerStyle="title"
             headerCode="Treatment support">
        <div class="section-container">

            <h4>
                <uimessage code="Surgery" />
            </h4>
            <p class="list-inline">
                <label>
                    <uimessage code="Surgery recommended" />
                </label>
                <obs conceptId="CIEL:164258" style="radio"
                     answerConceptIds="CIEL:1065,CIEL:1066"
                     answerCodes="yes,no" />
            </p>

            <h4>
                <uimessage code="Birth plan" />
            </h4>
            <div class="four-columns">
                <div>
                    <ifMode mode="VIEW" include="false">
                        <lookup complexExpression="#set( $priorEyeDrops = $fn.latestObsInVisitPriorToEncounter('CIEL:1651', 'CIEL:168724') )"/>
                        <includeIf velocityTest="( $priorEyeDrops )">
                            <span class="prior-obs-value">[ x ] <lookup complexExpression="$priorEyeDrops.obsDatetime"/></span>
                        </includeIf>
                        <br/>
                    </ifMode>
                    <obs conceptId="CIEL:1651" style="checkbox"
                         answerConceptId="CIEL:168724" answerCode="Prophylactic eye drops" />
                </div>

                <div>
                    <!-- Vitamin K -->
                    <ifMode mode="VIEW" include="false">
                        <lookup complexExpression="#set( $priorSupplement = $fn.latestObsInVisitPriorToEncounter('PIH:SUPPLEMENT RECEIVED', 'CIEL:86352') )"/>
                        <includeIf velocityTest="( $priorSupplement )">
                            <span class="prior-obs-value">[ x ] <lookup complexExpression="$priorSupplement.obsDatetime"/></span>
                        </includeIf>
                        <br/>
                    </ifMode>
                    <obs conceptId="PIH:SUPPLEMENT RECEIVED" style="checkbox"
                         answerConceptId="CIEL:86352" />
                </div>

                <div>
                    <ifMode mode="VIEW" include="false">
                        <br/>
                    </ifMode>
                    <obs conceptId="PIH:SUPPLEMENT RECEIVED" style="checkbox"
                         answerConceptId="CIEL:105310" answerCode="Vitamin D"/>
                </div>

                <div>
                    <ifMode mode="VIEW" include="false">
                        <lookup complexExpression="#set( $priorCordCare = $fn.latestObsInVisitPriorToEncounter('CIEL:1651', 'CIEL:168725') )"/>
                        <includeIf velocityTest="( $priorCordCare )">
                            <span class="prior-obs-value">[ x ] <lookup complexExpression="$priorCordCare.obsDatetime"/></span>
                        </includeIf>
                        <br/>
                    </ifMode>
                    <obs conceptId="CIEL:1651" style="checkbox"
                         answerConceptId="CIEL:168725" answerCode="Umbilical cord care" />
                </div>
            </div>
            <br/>

            <h4>
                <uimessage code="Treatment plan" />
            </h4>
            <obs conceptId="CIEL:163104" style="textarea" />

        </div>
    </section>

    <section id="drug-orders" sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="pihcore.visitNote.orders.medications">
        <div class="section-container">
            <p>
                <!-- Adrenaline administered -->
                <obs conceptId="PIH:12603" style="checkbox"
                     answerConceptId="CIEL:154365" answerCode="Adrenaline administered"
                     commentFieldLabel="if adrenaline administered, enter dosing information:" />
            </p>

            <subform path="configuration/pih/subforms/drug-order-widget-newborn.xml"/>
        </div>

        <div class="section-container">
            <!-- Medication comments -->
            <label>
                <uimessage code="pihcore.remarks"/>
            </label>
            <p>
                <obs conceptId="PIH:10637" cols="50" rows="5" />
            </p>
        </div>
    </section>

    <section id="outcome" sectionTag="fieldset" headerTag="legend" headerStyle="title"
             headerCode="Outcome">
        <div class="section-container">

            <p class="side-by-side">
                <label>
                    <uimessage code="Overall condition"/>
                </label>
                <obs id="outcome-condition" conceptId="CIEL:160116" style="radio"
                     answerConceptIds="CIEL:160113,CIEL:160115"/>

                <div id="disposition">
                    <encounterDisposition />
                </div>
            </p>

            <label>
                <uimessage code="pih.app.notes.summary" />
            </label>
            <obs conceptId="CIEL:161011" style="textarea" />

        </div>
    </section>

    <ifMode mode="VIEW" include="false">
        <div id="buttons">
            <submit submitClass="confirm right" submitCode="mirebalais.save"/>
            <button type="button" class="cancel">
                <uimessage code="emr.cancel"/>
            </button>
        </div>
    </ifMode>

</htmlform>
